<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="BinGo">
  
  
  
  <link rel="prev" href="https://huangyubin.xyz/2019/05/mysql-%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/" />
  <link rel="next" href="https://huangyubin.xyz/2019/09/mysql-%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6%E7%9A%84%E6%80%9D%E8%80%83/" />
  <link rel="canonical" href="https://huangyubin.xyz/2019/09/golang-channel-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           Golang Channel å­¦ä¹ ç¬”è®° | BinGo&#39;s Blog
       
  </title>
  <meta name="title" content="Golang Channel å­¦ä¹ ç¬”è®° | BinGo&#39;s Blog">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/huangyubin.xyz"
    },
    "articleSection" : "posts",
    "name" : "Golang Channel å­¦ä¹ ç¬”è®°",
    "headline" : "Golang Channel å­¦ä¹ ç¬”è®°",
    "description" : "ç®€ä»‹ Channel æ˜¯ Go è¯­è¨€ä¸­å¹¶å‘æ¨¡å‹çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå¯ä»¥åœ¨ä¸åŒçš„ goroutine ä¹‹é—´è¿›è¡Œæ•°æ®çš„ä¼ è¾“ã€‚\nåœ¨æ—¥å¸¸ä½¿ç”¨ä¸­ï¼Œchannel å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼š\n æ— ç¼“å†² channelï¼šåœ¨æ— ç¼“å†² channel ä¸­ï¼Œæ•°æ®çš„å‘é€å’Œè¯»å–æ“ä½œéœ€è¦åŒæ—¶è¿›è¡Œï¼Œå½“åªæœ‰ä¸€ä¸ª goroutine A è¿›è¡Œæ•°æ®çš„è¯»å–ï¼ˆå†™å…¥ï¼‰æ—¶ï¼Œéœ€è¦ç­‰å¾…å¦ä¸€ä¸ª goroutine B é€šè¿‡è¿™ä¸ª channel è¿›è¡Œæ•°æ®å†™å…¥ï¼ˆè¯»å–ï¼‰ã€‚åœ¨æ­¤ä¹‹å‰ goroutine A ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ° goroutine Bæ¥æ‹¯æ•‘å®ƒã€‚ æœ‰ç¼“å†² channelï¼šåœ¨æœ‰ç¼“å†² channel ä¸­ï¼Œä¼šè‡ªå¸¦ä¸€ä¸ªç¼“å†²å¾ªç¯é˜Ÿåˆ—ã€‚å½“ goroutine è¿›è¡Œæ•°æ®è¯»å–æ—¶ï¼Œå¦‚æœç¼“å†²é˜Ÿåˆ—ä¸­æœ‰æ•°æ®ä¾¿ç›´æ¥è¯»å–ï¼Œå¦‚æœæ²¡æœ‰ä¾¿é˜»å¡ç­‰å¾…å…¶ä»– goroutine å†™å…¥æ•°æ®ã€‚å½“ goroutine è¿›è¡Œæ•°æ®å†™å…¥æ—¶ï¼Œå¦‚æœç¼“å†²é˜Ÿåˆ—æ²¡æœ‰æ»¡ï¼Œåˆ™ç›´æ¥å†™å…¥æ•°æ®åç¦»å¼€ã€‚å¦‚æœç¼“å†²é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™éœ€è¦ç­‰å¾…å…¶ä»– goroutine æ¥æ¶ˆè´¹ç¼“å†²é˜Ÿåˆ—ï¼Œæ‰èƒ½ç»§ç»­å†™å…¥ï¼Œåœ¨æ­¤ä¹‹å‰åªèƒ½ä¸€ç›´é˜»å¡ã€‚  Channel æ•°æ®ç»“æ„ é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ Go è¯­è¨€ä¸­ Channel çš„æ•°æ®ç»“æ„ï¼š\n# go1.13:src\/runtime\/chan.go:32 type hchan struct { qcount uint \/\/ å½“å‰channelä¸­å…ƒç´ çš„ä¸ªæ•° \tdataqsiz uint \/\/ å¾ªç¯é˜Ÿåˆ—çš„é•¿åº¦ \tbuf unsafe.Pointer \/\/ æŒ‡é’ˆ, æŒ‡å‘ä¸€ä¸ªé•¿åº¦ä¸ºdataqsizeçš„æ•°ç»„, å³ç¼“å†²é˜Ÿåˆ— \telemsize uint16 \/\/ channelå¯ä»¥æ¥æ”¶çš„å…ƒç´ å¤§å°(å•ä¸ª) \tclosed uint32\t\/\/ channelçš„å…³é—­çŠ¶æ€ \telemtype *_type \/\/ channelå¯ä»¥æ¥æ”¶çš„å…ƒç´ ç±»å‹ \tsendx uint \/\/ æ ‡ç¤ºå½“å‰å¯å‘é€å…ƒç´ çš„ä½ç½®(æ•°ç»„ä¸‹æ ‡) \trecvx uint \/\/ æ ‡ç¤ºå½“å‰å¯æ¥æ”¶å…ƒç´ çš„ä½ç½®(æ•°ç»„ä¸‹æ ‡) \trecvq waitq \/\/ é˜»å¡çš„æ¥æ”¶ goroutine é˜Ÿåˆ— \tsendq waitq \/\/ é˜»å¡çš„å‘é€ goroutine é˜Ÿåˆ—  \/\/ lock protects all fields in hchan, as well as several \t\/\/ fields in sudogs blocked on this channel.",
    "inLanguage" : "en-us",
    "author" : "BinGo",
    "creator" : "BinGo",
    "publisher": "BinGo",
    "accountablePerson" : "BinGo",
    "copyrightHolder" : "BinGo",
    "copyrightYear" : "2019",
    "datePublished": "2019-09-03 20:49:19 \u002b0800 CST",
    "dateModified" : "2019-09-03 20:49:19 \u002b0800 CST",
    "url" : "https:\/\/huangyubin.xyz\/2019\/09\/golang-channel-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0\/",
    "wordCount" : "1598",
    "keywords" : [ "Golang","æºç å­¦ä¹ ", "BinGo\u0027s Blog"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-flickr"></i></a>&nbsp;<a href="https://huangyubin.xyz">BinGo&#39;s Blog</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/index.xml" title="">RSS</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-flickr"></i></a>&nbsp;<a href="https://huangyubin.xyz">BinGo&#39;s Blog</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/index.xml" title="">RSS</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">Golang Channel å­¦ä¹ ç¬”è®°</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://huangyubin.xyz" rel="author">BinGo</a>
                <span class="post-time">
                on <time datetime=2019-09-03 itemprop="datePublished">September 3, 2019</time>
                </span>
                in
                <i class="iconfont icon-folder"></i>
                <span class="post-category">
                        <a href="https://huangyubin.xyz/categories/golang/"> Golang </a>
                        <a href="https://huangyubin.xyz/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"> å­¦ä¹ ç¬”è®° </a>
                        
                </span>
        </div>
    </header>
    
    <div class="post-content">
        

        

        
        
     
          
          
          

          
          
          

          <h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p>Channel æ˜¯ Go è¯­è¨€ä¸­å¹¶å‘æ¨¡å‹çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå¯ä»¥åœ¨ä¸åŒçš„ goroutine ä¹‹é—´è¿›è¡Œæ•°æ®çš„ä¼ è¾“ã€‚</p>
<p>åœ¨æ—¥å¸¸ä½¿ç”¨ä¸­ï¼Œchannel å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼š</p>
<ul>
<li>æ— ç¼“å†² channelï¼šåœ¨æ— ç¼“å†² channel ä¸­ï¼Œæ•°æ®çš„å‘é€å’Œè¯»å–æ“ä½œéœ€è¦åŒæ—¶è¿›è¡Œï¼Œå½“åªæœ‰ä¸€ä¸ª goroutine A è¿›è¡Œæ•°æ®çš„è¯»å–ï¼ˆå†™å…¥ï¼‰æ—¶ï¼Œéœ€è¦ç­‰å¾…å¦ä¸€ä¸ª goroutine B é€šè¿‡è¿™ä¸ª channel è¿›è¡Œæ•°æ®å†™å…¥ï¼ˆè¯»å–ï¼‰ã€‚åœ¨æ­¤ä¹‹å‰ goroutine A ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ° goroutine Bæ¥æ‹¯æ•‘å®ƒã€‚</li>
<li>æœ‰ç¼“å†² channelï¼šåœ¨æœ‰ç¼“å†² channel ä¸­ï¼Œä¼šè‡ªå¸¦ä¸€ä¸ªç¼“å†²å¾ªç¯é˜Ÿåˆ—ã€‚å½“ goroutine è¿›è¡Œæ•°æ®è¯»å–æ—¶ï¼Œå¦‚æœç¼“å†²é˜Ÿåˆ—ä¸­æœ‰æ•°æ®ä¾¿ç›´æ¥è¯»å–ï¼Œå¦‚æœæ²¡æœ‰ä¾¿é˜»å¡ç­‰å¾…å…¶ä»– goroutine å†™å…¥æ•°æ®ã€‚å½“ goroutine è¿›è¡Œæ•°æ®å†™å…¥æ—¶ï¼Œå¦‚æœç¼“å†²é˜Ÿåˆ—æ²¡æœ‰æ»¡ï¼Œåˆ™ç›´æ¥å†™å…¥æ•°æ®åç¦»å¼€ã€‚å¦‚æœç¼“å†²é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™éœ€è¦ç­‰å¾…å…¶ä»– goroutine æ¥æ¶ˆè´¹ç¼“å†²é˜Ÿåˆ—ï¼Œæ‰èƒ½ç»§ç»­å†™å…¥ï¼Œåœ¨æ­¤ä¹‹å‰åªèƒ½ä¸€ç›´é˜»å¡ã€‚</li>
</ul>
<h2 id="channel-æ•°æ®ç»“æ„">Channel æ•°æ®ç»“æ„</h2>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ Go è¯­è¨€ä¸­ Channel çš„æ•°æ®ç»“æ„ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.13</span>:<span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#66d9ef">chan</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">32</span> 
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">hchan</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">qcount</span>   <span style="color:#66d9ef">uint</span>           <span style="color:#75715e">// å½“å‰channelä¸­å…ƒç´ çš„ä¸ªæ•°
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dataqsiz</span> <span style="color:#66d9ef">uint</span>           <span style="color:#75715e">// å¾ªç¯é˜Ÿåˆ—çš„é•¿åº¦
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">buf</span>      <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span> <span style="color:#75715e">// æŒ‡é’ˆ, æŒ‡å‘ä¸€ä¸ªé•¿åº¦ä¸ºdataqsizeçš„æ•°ç»„, å³ç¼“å†²é˜Ÿåˆ—
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">elemsize</span> <span style="color:#66d9ef">uint16</span> <span style="color:#75715e">// channelå¯ä»¥æ¥æ”¶çš„å…ƒç´ å¤§å°(å•ä¸ª)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">closed</span>   <span style="color:#66d9ef">uint32</span>	<span style="color:#75715e">// channelçš„å…³é—­çŠ¶æ€
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">elemtype</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">_type</span> <span style="color:#75715e">// channelå¯ä»¥æ¥æ”¶çš„å…ƒç´ ç±»å‹
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">sendx</span>    <span style="color:#66d9ef">uint</span>   <span style="color:#75715e">// æ ‡ç¤ºå½“å‰å¯å‘é€å…ƒç´ çš„ä½ç½®(æ•°ç»„ä¸‹æ ‡)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">recvx</span>    <span style="color:#66d9ef">uint</span>   <span style="color:#75715e">// æ ‡ç¤ºå½“å‰å¯æ¥æ”¶å…ƒç´ çš„ä½ç½®(æ•°ç»„ä¸‹æ ‡)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">recvq</span>    <span style="color:#a6e22e">waitq</span>  <span style="color:#75715e">// é˜»å¡çš„æ¥æ”¶ goroutine é˜Ÿåˆ—
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">sendq</span>    <span style="color:#a6e22e">waitq</span>  <span style="color:#75715e">// é˜»å¡çš„å‘é€ goroutine é˜Ÿåˆ—
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">// lock protects all fields in hchan, as well as several
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// fields in sudogs blocked on this channel.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Do not change another G&#39;s status while holding this lock
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// (in particular, do not ready a G), as this can deadlock
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// with stack shrinking.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">lock</span> <span style="color:#a6e22e">mutex</span>	<span style="color:#75715e">// åŸå­é”ğŸ”’
</span><span style="color:#75715e"></span>}

<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.13.7</span>:<span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#66d9ef">chan</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">53</span>
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">waitq</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">first</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sudog</span>	<span style="color:#75715e">//æŒ‡å‘é˜Ÿåˆ—å¤´éƒ¨çš„ goroutine æŒ‡é’ˆ
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">last</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">sudog</span>	<span style="color:#75715e">//æŒ‡å‘é˜Ÿåˆ—å°¾éƒ¨çš„ goroutine æŒ‡é’ˆ
</span><span style="color:#75715e"></span>}
</code></pre></div><p>channel åœ¨ Go è¯­è¨€ä¸­æ˜¯ä»¥  <code>hchan</code> ç»“æ„ä½“å­˜åœ¨çš„ï¼Œç»“æ„ä½“ä¸­çš„å­—æ®µå¦‚æ³¨é‡Šæ‰€ç¤ºã€‚å…¶ä¸­  <code>sudog</code> å¯ä»¥è®¤ä¸ºæ˜¯ goroutine çš„é¢å¤–å°è£…ã€‚</p>
<h2 id="channel-åˆ›å»º">Channel åˆ›å»º</h2>
<p>channel çš„åˆ›å»ºæœ€ç»ˆéƒ½ä¼šè°ƒç”¨  <code>makechan()</code> æ¥å£ï¼Œè¯ä¸å¤šè¯´å…ˆä¸Šæºç ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.13</span>:<span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#66d9ef">chan</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">71</span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">makechan</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">chantype</span>, <span style="color:#a6e22e">size</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span> {
	<span style="color:#a6e22e">elem</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">elem</span>

	<span style="color:#75715e">// compiler checks this but be safe.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">size</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">16</span> {	<span style="color:#75715e">// channelå…ƒç´ å¤§å°æ ¡éªŒ, ä¸èƒ½è¶…è¿‡64KB
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">throw</span>(<span style="color:#e6db74">&#34;makechan: invalid channel element type&#34;</span>)
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">hchanSize</span><span style="color:#f92672">%</span><span style="color:#a6e22e">maxAlign</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">align</span> &gt; <span style="color:#a6e22e">maxAlign</span> { <span style="color:#75715e">// å†…å­˜å¯¹é½é™åˆ¶æ£€æŸ¥
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">throw</span>(<span style="color:#e6db74">&#34;makechan: bad alignment&#34;</span>)
	}

	<span style="color:#a6e22e">mem</span>, <span style="color:#a6e22e">overflow</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">math</span>.<span style="color:#a6e22e">MulUintptr</span>(<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">size</span>, uintptr(<span style="color:#a6e22e">size</span>)) <span style="color:#75715e">//ç”³è¯·å†…å­˜çš„é¢„æ£€æŸ¥
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">overflow</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">mem</span> &gt; <span style="color:#a6e22e">maxAlloc</span><span style="color:#f92672">-</span><span style="color:#a6e22e">hchanSize</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">size</span> &lt; <span style="color:#ae81ff">0</span> {
		panic(<span style="color:#a6e22e">plainError</span>(<span style="color:#e6db74">&#34;makechan: size out of range&#34;</span>))
	}

	<span style="color:#75715e">// Hchan does not contain pointers interesting for GC when elements stored in buf do not contain pointers.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// buf points into the same allocation, elemtype is persistent.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// SudoG&#39;s are referenced from their owning thread so they can&#39;t be collected.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// TODO(dvyukov,rlh): Rethink when collector can move allocated objects.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>
	<span style="color:#66d9ef">switch</span> {
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">mem</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
		<span style="color:#75715e">// Queue or element size is zero.
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span> = (<span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>)(<span style="color:#a6e22e">mallocgc</span>(<span style="color:#a6e22e">hchanSize</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">true</span>))
		<span style="color:#75715e">// Race detector uses this location for synchronization.
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">buf</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">raceaddr</span>()
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">ptrdata</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
		<span style="color:#75715e">// Elements do not contain pointers.
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// Allocate hchan and buf in one call.
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span> = (<span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>)(<span style="color:#a6e22e">mallocgc</span>(<span style="color:#a6e22e">hchanSize</span><span style="color:#f92672">+</span><span style="color:#a6e22e">mem</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">true</span>))
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">buf</span> = <span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">c</span>), <span style="color:#a6e22e">hchanSize</span>)
	<span style="color:#66d9ef">default</span>:
		<span style="color:#75715e">// Elements contain pointers.
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span> = new(<span style="color:#a6e22e">hchan</span>)
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">buf</span> = <span style="color:#a6e22e">mallocgc</span>(<span style="color:#a6e22e">mem</span>, <span style="color:#a6e22e">elem</span>, <span style="color:#66d9ef">true</span>)
	}

	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemsize</span> = uint16(<span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">size</span>)
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemtype</span> = <span style="color:#a6e22e">elem</span>
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span> = uint(<span style="color:#a6e22e">size</span>)

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">debugChan</span> {
		print(<span style="color:#e6db74">&#34;makechan: chan=&#34;</span>, <span style="color:#a6e22e">c</span>, <span style="color:#e6db74">&#34;; elemsize=&#34;</span>, <span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">size</span>, <span style="color:#e6db74">&#34;; elemalg=&#34;</span>, <span style="color:#a6e22e">elem</span>.<span style="color:#a6e22e">alg</span>, <span style="color:#e6db74">&#34;; dataqsiz=&#34;</span>, <span style="color:#a6e22e">size</span>, <span style="color:#e6db74">&#34;\n&#34;</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>
}
</code></pre></div><p>é¦–å…ˆæ˜¯ä¸€ç³»åˆ—çš„å®‰å…¨æ£€æŸ¥ï¼š</p>
<ul>
<li>
<p>æ£€æŸ¥ channel å…ƒç´ ç±»å‹çš„å¤§å°ï¼Œä¸èƒ½è¶…è¿‡64KBã€‚</p>
</li>
<li>
<p>æ£€æŸ¥ chennel å…ƒç´ ç»“æ„ä½“æ˜¯å¦å·²ç»å¯¹é½ï¼Œä»¥åŠ channel ä¸­çš„å…ƒç´ å†…å­˜å¯¹é½å€¼ä¸å¾—è¶…è¿‡  maxAlign ï¼ˆåœ¨å½“å‰ç‰ˆæœ¬ä¸­ maxAlign çš„å€¼ä¸º8ï¼‰</p>
</li>
<li>
<p>æ£€æŸ¥ç¼“å†²é˜Ÿåˆ—çš„å†…å­˜ç”³è¯·æ˜¯å¦è¶…è¿‡é™åˆ¶ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªåˆ¤æ–­ï¼š</p>
<ul>
<li>
<p>ç”³è¯·çš„å†…å­˜æ˜¯å¦æº¢å‡º</p>
</li>
<li>
<p>æ˜¯å¦è¶…è¿‡å…è®¸åˆ›å»ºçš„æœ€å¤§å†…å­˜é™åˆ¶ã€‚è¿™é‡Œéœ€è¦å‡å» channel ç»“æ„æœ¬èº«çš„å†…å­˜å ç”¨ hchanSizeï¼Œè¿™ä¸ªå†…å­˜å ç”¨å¤§å°çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Sizeof</span>(<span style="color:#a6e22e">hchan</span>{}) <span style="color:#f92672">+</span> uintptr(<span style="color:#f92672">-</span>int(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Sizeof</span>(<span style="color:#a6e22e">hchan</span>{}))<span style="color:#f92672">&amp;</span>(<span style="color:#a6e22e">maxAlign</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
</code></pre></div></li>
<li>
<p>å½“ç„¶ï¼Œç”³è¯·çš„å†…å­˜å¤§å°ä¸èƒ½ä¸ºè´Ÿæ•°</p>
</li>
</ul>
</li>
</ul>
<p>é€šè¿‡å®‰å…¨æ£€æŸ¥ä¹‹åï¼Œä¼šå£°æ˜ <code>hchan</code> æŒ‡é’ˆ cï¼Œæ ¹æ®3ç§ä¸åŒçš„æƒ…å†µå¯¹ c è¿›è¡Œåˆå§‹åŒ–ï¼š</p>
<ul>
<li>åˆ›å»ºçš„æ˜¯æ— ç¼“å†² channel ï¼šå³ç”³è¯·ç¼“å†²é˜Ÿåˆ—çš„å¤§å°ä¸º0ï¼Œè¿™ä¸ªæ—¶å€™ä¼šä¸º c ç”³è¯· hchanSize å¤§å°çš„å†…å­˜ã€‚åŒæ—¶è°ƒç”¨ raceaddr() å¯¹ç¼“å†²é˜Ÿåˆ—æŒ‡é’ˆåœ°å€è¿›è¡Œè¯»å†™æ“ä½œï¼Œä¸»è¦ä½œç”¨æ˜¯ä¸ºäº†é˜²æ­¢åœ¨è°ƒç”¨ len() æˆ– cap() å‡½æ•°æ—¶è¯»å–å†…å­˜åœ°å€å’Œå…¶ä»–æ“ä½œäº§ç”Ÿèµ„æºç«äº‰ã€‚</li>
<li>åˆ›å»ºçš„æ˜¯æœ‰ç¼“å†² channel ä¸”ç¼“å†²é˜Ÿåˆ—å…ƒç´ ä¸åŒ…å«æŒ‡é’ˆï¼šä¼šä¸º c ç”³è¯·ä¸€æ®µ hchanSize + mem å¤§å°çš„å†…å­˜ï¼Œå¹¶å°†ç¼“å†²é˜Ÿåˆ—æŒ‡é’ˆæŒ‡å‘å†…å­˜åœ°å€åæ®µï¼Œå³åŠ ä¸Š hchanSize çš„åç§»é‡åæŒ‡å‘ä¸€æ®µé•¿åº¦ä¸º mem çš„å†…å­˜åœ°å€ã€‚</li>
<li>åˆ›å»ºçš„æ˜¯æœ‰ç¼“å†² channel ä¸”ç¼“å†²é˜Ÿåˆ—å…ƒç´ åŒ…å«æŒ‡é’ˆï¼šåˆ†åˆ«ä¸º c å’Œç¼“å†²é˜Ÿåˆ— c.buf åˆ†é…å¯¹åº”å¤§å°çš„å†…å­˜ã€‚</li>
</ul>
<p>å‰©ä¸‹çš„æ“ä½œä¾¿æ˜¯ä¸€äº›ä¸Šæ–‡æåˆ°çš„å˜é‡åˆå§‹åŒ–å’Œ Debug æ—¥å¿—è¾“å‡ºäº†ã€‚</p>
<h2 id="channel-å‘é€">Channel å‘é€</h2>
<p>channel çš„å‘é€é€»è¾‘å®ç°ä¸»è¦æ˜¯åœ¨ <code>src/runtime/chan.go</code> ä¸­çš„  <code>chansend()</code> å’Œ <code>send()</code>ï¼Œç”±äºå®ç°é€»è¾‘æ¯”è¾ƒå†—é•¿ï¼Œæƒ…å†µä¹Ÿæ¯”è¾ƒå¤šï¼Œè¿™é‡Œå°±ä¸ç›´æ¥ä»£ç éª‘è„¸ï¼Œæˆ‘ä»¬æ ¹æ®ä¸åŒçš„æƒ…å†µå…·ä½“åˆ†æï¼š</p>
<h3 id="æ— ç¼“å†²-channel-å‘é€">æ— ç¼“å†² channel å‘é€</h3>
<h4 id="ç›´æ¥å‘é€">ç›´æ¥å‘é€</h4>
<p>å‰æ–‡è¯´è¿‡æ— ç¼“å†² channel åœ¨å‘é€æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¯¹åº”æ¥æ”¶çš„ goroutineï¼Œå°±ä¼šå°†å½“å‰çš„å‘é€ goroutine æ”¾å…¥ sendq é˜Ÿåˆ—ï¼Œæ‰€ä»¥å‘é€æ—¶ï¼Œç¬¬ä¸€æ­¥ä¼šå…ˆæ£€æŸ¥ recvq é˜Ÿåˆ—æ˜¯å¦æœ‰æ¥æ”¶ goroutine åœ¨ç­‰å¾…æ¥æ”¶ï¼Œ å¦‚æœå·²ç»æœ‰ç­‰å¾…æ¥æ”¶çš„ goroutineï¼Œä¾¿ç›´æ¥è°ƒç”¨ <code>send()</code> è¿›è¡Œæ•°æ®å‘é€ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.13</span>:<span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#66d9ef">chan</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">190</span>
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvq</span>.<span style="color:#a6e22e">dequeue</span>(); <span style="color:#a6e22e">sg</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
	<span style="color:#75715e">// Found a waiting receiver. We pass the value we want to send
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// directly to the receiver, bypassing the channel buffer (if any).
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">sg</span>, <span style="color:#a6e22e">ep</span>, <span style="color:#66d9ef">func</span>() { <span style="color:#a6e22e">unlock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>) }, <span style="color:#ae81ff">3</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
}
</code></pre></div><h4 id="å‘é€é˜»å¡">å‘é€é˜»å¡</h4>
<p>å½“æ¥æ”¶é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ï¼Œç¨‹åºä¼šæ£€æŸ¥å½“å‰ channel çš„ç¼“å†²é˜Ÿåˆ—æ˜¯å¦å¯ç”¨ï¼ˆå½“ç„¶åœ¨æ— ç¼“å†² channel ä¸­ç­”æ¡ˆæ—¶è‚¯å®šä¸è¡Œçš„ï¼‰ï¼Œäºæ˜¯ä¼šè·å–å½“å‰å‘é€çš„ goroutineï¼Œæ ¹æ®è¿™ä¸ª goroutine å°è£…ä¸€ä¸ªä¸Šæ–‡æåˆ°çš„ <code>sudog</code> ç»“æ„å¹¶æ”¾å…¥ sendq é˜Ÿåˆ—ä¸­å¹¶å°†å½“å‰çš„ goroutine è®¾ç½®ä¸ºä¼‘çœ çŠ¶æ€ï¼ˆé€šè¿‡è°ƒç”¨ <code>goparkunlock()</code>ï¼‰ã€‚åŒæ—¶ä¹Ÿä¼šè°ƒç”¨ <code>KeepAlive()</code> å°†å½“å‰å‘é€çš„æ•°æ®ï¼ˆå®é™…ä¸Šæ˜¯ä¸€ä¸ªæŒ‡å‘å½“å‰æ•°æ®çš„æŒ‡é’ˆï¼‰æ ‡è®°ä¸º reachable ä»¥é˜²æ­¢æ•°æ®åœ¨å‘é€å‰è¢«é‡Šæ”¾æˆ–ä¿®æ”¹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.13</span>:<span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#66d9ef">chan</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">219</span>
<span style="color:#75715e">// Block on the channel. Some receiver will complete our operation for us.
</span><span style="color:#75715e"></span><span style="color:#a6e22e">gp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getg</span>()
<span style="color:#a6e22e">mysg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">acquireSudog</span>()
<span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">releasetime</span> = <span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t0</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
	<span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">releasetime</span> = <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
}
<span style="color:#75715e">// No stack splits between assigning elem and enqueuing mysg
</span><span style="color:#75715e">// on gp.waiting where copystack can find it.
</span><span style="color:#75715e"></span><span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">elem</span> = <span style="color:#a6e22e">ep</span>
<span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">waitlink</span> = <span style="color:#66d9ef">nil</span>
<span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">g</span> = <span style="color:#a6e22e">gp</span>
<span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">isSelect</span> = <span style="color:#66d9ef">false</span>
<span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">c</span> = <span style="color:#a6e22e">c</span>
<span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">waiting</span> = <span style="color:#a6e22e">mysg</span>
<span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">param</span> = <span style="color:#66d9ef">nil</span>
<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendq</span>.<span style="color:#a6e22e">enqueue</span>(<span style="color:#a6e22e">mysg</span>)
<span style="color:#a6e22e">goparkunlock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>, <span style="color:#a6e22e">waitReasonChanSend</span>, <span style="color:#a6e22e">traceEvGoBlockSend</span>, <span style="color:#ae81ff">3</span>)
<span style="color:#75715e">// Ensure the value being sent is kept alive until the
</span><span style="color:#75715e">// receiver copies it out. The sudog has a pointer to the
</span><span style="color:#75715e">// stack object, but sudogs aren&#39;t considered as roots of the
</span><span style="color:#75715e">// stack tracer.
</span><span style="color:#75715e"></span><span style="color:#a6e22e">KeepAlive</span>(<span style="color:#a6e22e">ep</span>)
</code></pre></div><h3 id="æœ‰ç¼“å†²-channel-å‘é€">æœ‰ç¼“å†² channel å‘é€</h3>
<h4 id="ç›´æ¥å‘é€-1">ç›´æ¥å‘é€</h4>
<p>åŒæ— ç¼“å†² channel ä¸€æ ·ï¼Œå‘é€çš„ç¬¬ä¸€ä»¶äº‹æ˜¯å¯¹æ¥æ”¶é˜Ÿåˆ— recvq è¿›è¡Œæ£€æŸ¥ï¼ˆå› ä¸ºæ­¤æ—¶å¦‚æœ recvq é˜Ÿåˆ—æœ‰æ­£åœ¨ç­‰å¾…æ¥æ”¶çš„ goroutineï¼Œé‚£ä¹ˆç¼“å†²åŒºçš„æ•°æ®ä¸€å®šå·²ç»è¢«è¯»å–å®Œäº†ï¼‰ï¼Œå¦‚æœæœ‰æ­£åœ¨ç­‰å¾…æ¥æ”¶çš„ goroutineï¼Œé‚£ä¹ˆè·Ÿä¸Šæ–‡çš„æ— ç¼“å†² channel æ˜¯ä¸€æ ·çš„å¤„ç†ã€‚ä¸åŒçš„åœ°æ–¹åœ¨äºï¼Œå¦‚æœ recvq é˜Ÿåˆ—ä¸ºç©ºï¼Œç¨‹åºä¼šç»§ç»­æ£€æŸ¥å½“å‰ç¼“å†²åŒºæ˜¯å¦è¿˜æœ‰ç©ºé—´ï¼Œå¦‚æœè¿˜æœ‰ç©ºé—´ï¼Œä¾¿å°†å‘é€çš„æ•°æ®å†™å…¥ç¼“å†²åŒºï¼Œè€Œå½“å‰çš„ goroutine å°±å¯ä»¥ç»§ç»­å¾€ä¸‹æ‰§è¡Œäº†ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.13</span>:<span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#66d9ef">chan</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">197</span>
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">qcount</span> &lt; <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span> {
	<span style="color:#75715e">// Space is available in the channel buffer. Enqueue the element to send.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">qp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">chanbuf</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendx</span>) <span style="color:#75715e">//è·å–é˜Ÿåˆ—ä¸‹ä¸€ä¸ªä½ç½®å‘é€æ•°æ®çš„å­˜å‚¨ä½ç½®
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">raceenabled</span> {	<span style="color:#75715e">//ç«äº‰æ£€æµ‹ï¼Œåœ¨å½“å‰ç‰ˆæœ¬ä¸­ raceenabled é»˜è®¤ä¸º falseï¼Œåªæœ‰åœ¨è¿è¡Œæ—¶åŠ ä¸Š -race æ‰ä¼šæˆä¸º true
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">raceacquire</span>(<span style="color:#a6e22e">qp</span>)
		<span style="color:#a6e22e">racerelease</span>(<span style="color:#a6e22e">qp</span>)
	}
	<span style="color:#a6e22e">typedmemmove</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemtype</span>, <span style="color:#a6e22e">qp</span>, <span style="color:#a6e22e">ep</span>)	<span style="color:#75715e">//å°†å‘é€çš„æ•°æ®å¤åˆ¶åˆ°ç¼“å†²åŒº
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendx</span><span style="color:#f92672">++</span>	<span style="color:#75715e">//ç¼“å†²åŒºçš„å‘é€æŒ‡é’ˆä½ç½®è°ƒæ•´
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendx</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span> { <span style="color:#75715e">//å¾ªç¯é˜Ÿåˆ—å¸¸è§„æ“ä½œ
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendx</span> = <span style="color:#ae81ff">0</span>
	}
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">qcount</span><span style="color:#f92672">++</span>
	<span style="color:#a6e22e">unlock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
}
</code></pre></div><h4 id="å‘é€é˜»å¡-1">å‘é€é˜»å¡</h4>
<p>å¦‚æœç¼“å†²é˜Ÿåˆ—å®¹é‡å·²æ»¡ï¼Œé‚£ä¹ˆå³ä½¿æ˜¯æœ‰ç¼“å†²çš„ channelï¼Œä¹Ÿä¼šå°†å½“å‰å‘é€æ•°æ®çš„ goroutine æŒ‚èµ·ï¼Œå…·ä½“æ“ä½œå’Œæ— ç¼“å†² channel æ˜¯ä¸€è‡´çš„ï¼Œè¿™é‡Œå°±ä¸åšèµ˜è¿°äº†ï¼Œå¯ä»¥è‡ªè¡ŒæŸ¥çœ‹<a href="#%E5%8F%91%E9%80%81%E9%98%BB%E5%A1%9E">æ— ç¼“å†² channel å‘é€æ•°æ®é˜»å¡è¿‡ç¨‹</a>ã€‚</p>
<h3 id="å”¤é†’">å”¤é†’</h3>
<p>åœ¨é˜»å¡çŠ¶æ€è¿›è¡Œäº†æ¼«é•¿çš„ç­‰å¾…ä¹‹åï¼Œæœ‰ä¸€å¤©ï¼Œä¸€ä¸ªä»è¿œæ–¹è€Œæ¥è¿›è¡Œæ¥æ”¶æ•°æ®çš„ goroutine ç»ˆäºå‡ºç°ï¼Œè¿™ä¸ªæ—¶å€™ä¼‘çœ çŠ¶æ€çš„å‘é€ goroutine è¢«å”¤é†’ï¼Œè¿›è¡Œæ•°æ®çš„æ”¶å°¾åŠé‡Šæ”¾ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.13</span>:<span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#66d9ef">chan</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">243</span>
<span style="color:#75715e">// someone woke us up.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">mysg</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">waiting</span> {
	<span style="color:#a6e22e">throw</span>(<span style="color:#e6db74">&#34;G waiting list is corrupted&#34;</span>)
}
<span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">waiting</span> = <span style="color:#66d9ef">nil</span>
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">param</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">closed</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">throw</span>(<span style="color:#e6db74">&#34;chansend: spurious wakeup&#34;</span>)
	}
	panic(<span style="color:#a6e22e">plainError</span>(<span style="color:#e6db74">&#34;send on closed channel&#34;</span>))
}
<span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">param</span> = <span style="color:#66d9ef">nil</span>
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">releasetime</span> &gt; <span style="color:#ae81ff">0</span> {
	<span style="color:#a6e22e">blockevent</span>(<span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">releasetime</span><span style="color:#f92672">-</span><span style="color:#a6e22e">t0</span>, <span style="color:#ae81ff">2</span>)
}
<span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">c</span> = <span style="color:#66d9ef">nil</span>
<span style="color:#a6e22e">releaseSudog</span>(<span style="color:#a6e22e">mysg</span>)
</code></pre></div><p>ä¸»è¦çš„æ£€æŸ¥æœ‰ä¸¤ç‚¹ï¼Œä¸€ä¸ªæ˜¯å½“å‰ goroutine çš„é”å®šæ˜¯å¦è¢«ç¯¡æ”¹ï¼šgp.waiting æŒ‡å‘å½“å‰ goroutine è¢«å ç”¨ç­‰å¾…çš„  <code>sudog</code> ç»“æ„ä½“ã€‚å¦ä¸€ä¸ªæ£€æŸ¥æ˜¯å½“å‰ channel çš„å…³é—­çŠ¶æ€ï¼Œå€˜è‹¥å½“å‰ channel å·²ç»å…³é—­ï¼Œåˆ™ä¼šå¯¼è‡´ç¨‹åºPanicï¼Œå› ä¸ºä»ä¸€ä¸ªå·²ç»å…³é—­çš„ channel ä¸­å†™æ•°æ®æ˜¯ä¸è¢«å…è®¸çš„ã€‚</p>
<p>æ£€æŸ¥å®Œæ¯•ä¹‹åä¾¿æ˜¯å¯¹èµ„æºçš„å›æ”¶ã€‚è‡³æ­¤ä¸€ä¸ªå®Œæ•´çš„ channel å‘é€æµç¨‹ä¾¿èµ°å®Œäº†ã€‚</p>
<h3 id="how-to-send-">How to send ï¼Ÿ</h3>
<p>ä¸Šæ–‡æåˆ°å¦‚æœæ˜¯ä¸¤ä¸ª gouroutine ç›´æ¥è¿›è¡Œæ•°æ®äº¤æµï¼ˆä¸ç»è¿‡ç¼“å†²é˜Ÿåˆ—ï¼‰ï¼Œç¨‹åºä¼šè°ƒç”¨ <code>send()</code> è¿›è¡Œæ•°æ®å‘é€ï¼Œé‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•å‘é€æ•°æ®å‘¢ï¼Ÿ</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.13</span>:<span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#66d9ef">chan</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">269</span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>, <span style="color:#a6e22e">sg</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sudog</span>, <span style="color:#a6e22e">ep</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>, <span style="color:#a6e22e">unlockf</span> <span style="color:#66d9ef">func</span>(), <span style="color:#a6e22e">skip</span> <span style="color:#66d9ef">int</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">raceenabled</span> {	<span style="color:#75715e">// æ­£å¸¸è¿è¡ŒçŠ¶æ€ä¸‹ï¼Œraceenabled ä¸º falseï¼Œ æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æ— è§†å§ğŸ¤«
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">racesync</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">sg</span>)
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#75715e">// Pretend we go through the buffer, even though
</span><span style="color:#75715e"></span>			<span style="color:#75715e">// we copy directly. Note that we need to increment
</span><span style="color:#75715e"></span>			<span style="color:#75715e">// the head/tail locations only when raceenabled.
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">qp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">chanbuf</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvx</span>)
			<span style="color:#a6e22e">raceacquire</span>(<span style="color:#a6e22e">qp</span>)
			<span style="color:#a6e22e">racerelease</span>(<span style="color:#a6e22e">qp</span>)
			<span style="color:#a6e22e">raceacquireg</span>(<span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">g</span>, <span style="color:#a6e22e">qp</span>)
			<span style="color:#a6e22e">racereleaseg</span>(<span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">g</span>, <span style="color:#a6e22e">qp</span>)
			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvx</span><span style="color:#f92672">++</span>
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvx</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span> {
				<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvx</span> = <span style="color:#ae81ff">0</span>
			}
			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendx</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvx</span> <span style="color:#75715e">// c.sendx = (c.sendx+1) % c.dataqsiz
</span><span style="color:#75715e"></span>		}
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">elem</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">sendDirect</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemtype</span>, <span style="color:#a6e22e">sg</span>, <span style="color:#a6e22e">ep</span>) <span style="color:#75715e">// ç›´æ¥å°†æ•°æ® ep æ‹·è´åˆ°æ¥æ”¶çš„ goroutine ä¸­
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">elem</span> = <span style="color:#66d9ef">nil</span>
	}
	<span style="color:#a6e22e">gp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">g</span>
	<span style="color:#a6e22e">unlockf</span>()
	<span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">param</span> = <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">sg</span>)	<span style="color:#75715e">//å°†å½“å‰çš„ sudog è®¾ç½®ä¸ºæ¥æ”¶æ–¹ goroutine å”¤é†’åçš„å‚æ•°
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">releasetime</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">releasetime</span> = <span style="color:#a6e22e">cputicks</span>()
	}
	<span style="color:#a6e22e">goready</span>(<span style="color:#a6e22e">gp</span>, <span style="color:#a6e22e">skip</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)
}
</code></pre></div><p>raceenabled ç«äº‰æ£€æµ‹ç›¸å…³è¿™é‡Œæˆ‘ä»¬å°±ç•¥è¿‡ä¸å±•å¼€è®²äº†ï¼ˆå…¶å®æ˜¯ä¸ä¼šï¼‰ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ï¼Œä¸è¦å¿˜äº†å­¦æˆå½’æ¥è¯„è®ºåˆ†äº«ã€‚</p>
<p>åœ¨åˆ†æå‘é€é€»è¾‘ä¹‹å‰æˆ‘ä»¬è¦æ˜ç¡®ä¸¤ä»¶äº‹ï¼šä¸€ä¸ªæ˜¯åœ¨ <code>send()</code> ä¸­ä¼ å…¥çš„ sg å·²ç»ä¸æ˜¯å‘é€æ–¹çš„  <code>sudog</code> ç»“æ„ä½“è€Œæ˜¯æ•°æ®æ¥æ”¶é˜Ÿåˆ—ä¸­çš„æ¥æ”¶æ–¹ã€‚è¿˜æœ‰ä¸€ç‚¹æ˜¯æ­¤æ—¶æ•°æ®æ¥æ”¶æ–¹çš„ goroutine å¿…ç„¶æ˜¯ä¼‘çœ çŠ¶æ€çš„ã€‚</p>
<p>åœ¨ <code>send()</code> ä¸­ç¨‹åºè°ƒç”¨ <code>sendDirect()</code> å°†æ•°æ® ep çš„å†…å®¹<!-- raw HTML omitted --><strong>ç›´æ¥æ‹·è´</strong><!-- raw HTML omitted -->åˆ°æ¥æ”¶ goroutine çš„å†…å­˜ç©ºé—´ä¸­ï¼Œç„¶åå›æ”¶æŒ‡å‘è¯¥å†…å­˜çš„æŒ‡é’ˆï¼ŒåŒæ—¶ä¹Ÿä¼šå°†å½“å‰çš„ <code>sudog</code> è®¾ç½®ä¸ºæ¥æ”¶æ–¹ goroutine å”¤é†’åçš„å‚æ•°ã€‚æœ€åé€šè¿‡è°ƒç”¨ <code>goready()</code> å”¤é†’ä¼‘çœ çš„æ¥æ”¶ goroutine æ¥å®Œæˆæ•°æ®ä¼ è¾“çš„è¿‡ç¨‹ã€‚</p>
<h2 id="channel-æ¥æ”¶">Channel æ¥æ”¶</h2>
<p>channel çš„æ¥æ”¶é€»è¾‘åŒæ ·åœ¨ <code>src/runtime/chan.go</code> ä¸­ï¼Œä¸»è¦ä¹Ÿæ˜¯ <code>chanrecv()</code> å’Œ <code>recv()</code> ä¸¤ä¸ªæ¥å£ã€‚æ¥æ”¶é€»è¾‘å¤§ä½“ä¸Šå’Œå‘é€ååˆ†ç±»ä¼¼ï¼Œ~~ç”šè‡³å¯ä»¥ç†è§£ä¸ºä»…ä»…æ˜¯æ•°æ®æµåŠ¨çš„æ–¹å‘æ”¹å˜äº†è€Œå·²ã€‚~~ä¸»è¦çš„å·®å¼‚ä½“ç°åœ¨æ•°æ®çš„äº¤æ¢é€»è¾‘ã€‚</p>
<h3 id="æ— ç¼“å†²-channel-æ¥æ”¶">æ— ç¼“å†² channel æ¥æ”¶</h3>
<h4 id="ç›´æ¥æ¥æ”¶">ç›´æ¥æ¥æ”¶</h4>
<p>æ— ç¼“å†² channel åœ¨è¿›è¡Œæ•°æ®æ¥æ”¶æ—¶ï¼Œå¦‚æœå‘é€é˜Ÿåˆ— sendq å·²ç»æœ‰ç­‰å¾…çš„å‘é€ goroutineï¼Œé‚£ä¹ˆå½“å‰ goroutine ä¼šç›´æ¥å’Œè¿™ä¸ªå‘é€è€…è¿›è¡Œæ•°æ®æ‹·è´ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.13</span>:<span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#66d9ef">chan</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">473</span>
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendq</span>.<span style="color:#a6e22e">dequeue</span>(); <span style="color:#a6e22e">sg</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> { 	<span style="color:#75715e">//å¦‚æœæ•°æ®å‘é€ç­‰å¾…é˜Ÿåˆ—æœ‰æ­£åœ¨ç­‰å¾…çš„ goroutine
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Found a waiting sender. If buffer is size 0, receive value
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// directly from sender. Otherwise, receive from head of queue
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// and add sender&#39;s value to the tail of the queue (both map to
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// the same buffer slot because the queue is full).
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">recv</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">sg</span>, <span style="color:#a6e22e">ep</span>, <span style="color:#66d9ef">func</span>() { <span style="color:#a6e22e">unlock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>) }, <span style="color:#ae81ff">3</span>) <span style="color:#75715e">//æ•°æ®æ¥æ”¶å¤„ç†
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">true</span>
}
</code></pre></div><h4 id="æ¥æ”¶é˜»å¡">æ¥æ”¶é˜»å¡</h4>
<p>å½“å‘é€é˜Ÿåˆ— sendq ä¸Šæ²¡æœ‰æ­£åœ¨ç­‰å¾…å‘é€æ•°æ®çš„ goroutine æ—¶ï¼Œç”±äºä¸å­˜åœ¨ç¼“å†²é˜Ÿåˆ—ï¼Œå½“å‰ goroutine éœ€è¦åŒ…è£…æˆä¸Šæ–‡æåˆ°çš„ <code>sudog</code> ç»“æ„ä½“å¹¶æ’å…¥åˆ°æ•°æ®æ¥æ”¶ç­‰å¾…é˜Ÿåˆ— recvq ä¸­ã€‚ä¹‹åä¾¿æ˜¯è°ƒç”¨ <code>goparkunlock()</code> è®©å½“å‰ goroutine è¿›å…¥æ¼«é•¿çš„ç­‰å¾…äº†ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#75715e">// no sender available: block on this channel.
</span><span style="color:#75715e"></span><span style="color:#a6e22e">gp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getg</span>()
<span style="color:#a6e22e">mysg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">acquireSudog</span>()
<span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">releasetime</span> = <span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t0</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
	<span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">releasetime</span> = <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
}
<span style="color:#75715e">// No stack splits between assigning elem and enqueuing mysg
</span><span style="color:#75715e">// on gp.waiting where copystack can find it.
</span><span style="color:#75715e"></span><span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">elem</span> = <span style="color:#a6e22e">ep</span>
<span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">waitlink</span> = <span style="color:#66d9ef">nil</span>
<span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">waiting</span> = <span style="color:#a6e22e">mysg</span>
<span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">g</span> = <span style="color:#a6e22e">gp</span>
<span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">isSelect</span> = <span style="color:#66d9ef">false</span>
<span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">c</span> = <span style="color:#a6e22e">c</span>
<span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">param</span> = <span style="color:#66d9ef">nil</span>
<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvq</span>.<span style="color:#a6e22e">enqueue</span>(<span style="color:#a6e22e">mysg</span>)
<span style="color:#a6e22e">goparkunlock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>, <span style="color:#a6e22e">waitReasonChanReceive</span>, <span style="color:#a6e22e">traceEvGoBlockRecv</span>, <span style="color:#ae81ff">3</span>)
</code></pre></div><p>å’Œå‘é€ç•¥å¾®ä¸åŒçš„æ˜¯ï¼Œç”±äºæ•°æ®æ¥æ”¶æ“ä½œå¹¶æ²¡æœ‰æ•°æ®éœ€è¦ä¿æŠ¤ï¼Œæ‰€ä»¥å¹¶ä¸éœ€è¦ç±»ä¼¼ <code>KeepAlive()</code> è¿™æ ·çš„æ¥å£æ¥å¯¹æ•°æ®è¿›è¡Œå®‰å…¨é”å®šã€‚</p>
<h3 id="æœ‰ç¼“å†²-channel-æ¥æ”¶">æœ‰ç¼“å†² channel æ¥æ”¶</h3>
<h4 id="ç›´æ¥æ¥æ”¶-1">ç›´æ¥æ¥æ”¶</h4>
<p>å½“ goroutine ä»æŸä¸ªæœ‰ç¼“å†² channel æ¥æ”¶æ•°æ®æ—¶ï¼Œä¾ç„¶ä¼šå¯¹å‘é€é˜Ÿåˆ— sendq è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœé˜Ÿåˆ—ä¸­æœ‰ç­‰å¾…å‘é€çš„å¯¹è±¡ï¼Œé‚£ä¹ˆè¡¨ç¤ºå½“å‰æœ‰è®¸å¤šæ•°æ®å¯ä»¥æ¥æ”¶ï¼ˆæ»¡å®¹é‡ç¼“å†²é˜Ÿåˆ—+å‘é€ç­‰å¾…é˜Ÿåˆ—ï¼‰ï¼Œæ¥æ”¶çš„ goroutine ä¼šè°ƒç”¨ <code>recv()</code> æ¥å£è¿›è¡Œæ•°æ®äº¤æ¥ã€‚ä½†æ˜¯ï¼è¯·ä¸è¦è¯¯ä¼šæ•°æ®æ¥æ”¶çš„å¯¹è±¡æ˜¯ç­‰å¾…é˜Ÿåˆ—ä¸­çš„å‘é€è€…ã€‚channel çš„è°ƒåº¦éµå¾ª FIFO åŸåˆ™ï¼Œä¸ä¼šå› ä¸ºä½ æ˜¯ä¸€ä¸ªæ­£åœ¨ç­‰å¾…çš„ goroutine è€Œä¼˜å…ˆå¤„ç†ã€‚ç„¶è€Œå…·ä½“æ˜¯å¦‚ä½•æ¥æ”¶æ•°æ®ï¼Œåœ¨æ­¤å…ˆä¹°ä¸ªå…³å­ã€‚</p>
<p>å€˜è‹¥å‘é€é˜Ÿåˆ— sendq ä¸­æ²¡æœ‰ç­‰å¾…çš„å‘é€å¯¹è±¡ï¼Œä¸è¦æ…Œï¼Œæˆ‘ä»¬è¿˜æœ‰ç¼“å†²æ± ã€‚å½“ç¼“å†²é˜Ÿåˆ—å¤§å°ä¸ä¸º0æ—¶ï¼Œè¯´æ˜ä»æœ‰æ•°æ®å¯ä¾›æ¥æ”¶ï¼Œå½“å‰çš„ goroutine ä¼šè°ƒç”¨ <code>typedmemmove()</code> å°†ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ°è‡ªå·±çš„å†…å­˜ä¸­ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.13</span>:<span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#66d9ef">chan</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">482</span>
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">qcount</span> &gt; <span style="color:#ae81ff">0</span> {	<span style="color:#75715e">//åˆ¤æ–­å¾ªç¯é˜Ÿåˆ—ä¸­çš„ç¼“å†²å¯¹è±¡
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Receive directly from queue
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">qp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">chanbuf</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvx</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">raceenabled</span> {
		<span style="color:#a6e22e">raceacquire</span>(<span style="color:#a6e22e">qp</span>)
		<span style="color:#a6e22e">racerelease</span>(<span style="color:#a6e22e">qp</span>)
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ep</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">typedmemmove</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemtype</span>, <span style="color:#a6e22e">ep</span>, <span style="color:#a6e22e">qp</span>)	<span style="color:#75715e">//ç›´æ¥å°†ç¼“å†²åŒºä¸­çš„æ•°æ®æ‹·è´åˆ°å½“å‰ goroutine ä¸­
</span><span style="color:#75715e"></span>	}
	<span style="color:#a6e22e">typedmemclr</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemtype</span>, <span style="color:#a6e22e">qp</span>)	<span style="color:#75715e">//æ¸…é™¤ç¼“å†²åŒºä¸­çš„æ•°æ®
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvx</span><span style="color:#f92672">++</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvx</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span> {	<span style="color:#75715e">//å¾ªç¯é˜Ÿåˆ—å¸¸è§„æ“ä½œ
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvx</span> = <span style="color:#ae81ff">0</span>
	}
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">qcount</span><span style="color:#f92672">--</span>
	<span style="color:#a6e22e">unlock</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">true</span>
}
</code></pre></div><h4 id="æ¥æ”¶é˜»å¡-1">æ¥æ”¶é˜»å¡</h4>
<p>å½“ç¼“å†²é˜Ÿåˆ—ä¸­ä¹Ÿæ²¡æœ‰å¯æ¥æ”¶æ•°æ®æ—¶ï¼Œå³ä½¿æ˜¯ä¸€ä¸ªæœ‰ç¼“å†²çš„ channelï¼Œgoroutine ä¹Ÿè¦ä¹–ä¹–è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè¿™é‡Œçš„é€»è¾‘å’Œä¸Šæ–‡ä¸­æ— ç¼“å†² channel æ¥æ”¶é˜»å¡é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œå¯ä»¥è‡ªè¡Œå›é¡¾<a href="#%E6%8E%A5%E6%94%B6%E9%98%BB%E5%A1%9E">æ— ç¼“å†² channel æ¥æ”¶æ•°æ®é˜»å¡è¿‡ç¨‹</a></p>
<h3 id="å”¤é†’-1">å”¤é†’</h3>
<p>é˜»å¡çŠ¶æ€çš„æ¥æ”¶ goroutine åœ¨æ¼«é•¿çš„ç­‰å¾…ä¹‹åè¢«å”¤é†’ï¼Œè¿™ä¸ªæ—¶å€™å®ƒä¼šå‘ç°æ•°æ®å·²ç»æ‹·è´åˆ°è‡ªå·±çš„å†…å­˜ä¸­ï¼ˆç±»ä¼¼äºç¡äº†ä¸€å¤©ç„¶åé†’æ¥å‘ç°ä¸€å¤©çš„å·¥èµ„å·²ç»å‘åˆ°é“¶è¡Œå¡é‡Œé‚£ç§æ„Ÿè§‰ï¼‰ï¼Œéœ€è¦è‡ªå·±åšçš„ä»…ä»…æ˜¯æ•°æ®çš„æ•´ç†æ£€æŸ¥ç­‰æ”¶å°¾å·¥ä½œï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.13</span>:<span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#66d9ef">chan</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">526</span>
<span style="color:#75715e">// someone woke us up
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">mysg</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">waiting</span> {
	<span style="color:#a6e22e">throw</span>(<span style="color:#e6db74">&#34;G waiting list is corrupted&#34;</span>)
}
<span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">waiting</span> = <span style="color:#66d9ef">nil</span>
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">releasetime</span> &gt; <span style="color:#ae81ff">0</span> {
	<span style="color:#a6e22e">blockevent</span>(<span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">releasetime</span><span style="color:#f92672">-</span><span style="color:#a6e22e">t0</span>, <span style="color:#ae81ff">2</span>)
}
<span style="color:#a6e22e">closed</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">param</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span>
<span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">param</span> = <span style="color:#66d9ef">nil</span>
<span style="color:#a6e22e">mysg</span>.<span style="color:#a6e22e">c</span> = <span style="color:#66d9ef">nil</span>
<span style="color:#a6e22e">releaseSudog</span>(<span style="color:#a6e22e">mysg</span>)
</code></pre></div><p>è¿™é‡Œçš„æ£€æŸ¥ç›¸è¾ƒäºå‘é€çš„å”¤é†’æ“ä½œå°‘äº†ä¸€ä¸ª channel çš„å…³é—­çŠ¶æ€æ£€æŸ¥ã€‚å› ä¸ºåœ¨è®¾è®¡ä¸Šï¼Œå³ä½¿ channel å·²ç»è¢«å…³é—­ï¼Œåªè¦è¿˜æœ‰æ•°æ®æ®‹ç•™ï¼Œchannel ä¾ç„¶æ˜¯å¯è¯»çš„ã€‚</p>
<h3 id="how-to-receive-">How to receive ï¼Ÿ</h3>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œchannel ä¸­æ¥æ”¶å’Œå‘é€çš„é€»è¾‘è¿˜æ˜¯ååˆ†ç›¸ä¼¼çš„ï¼ŒçœŸæ­£çš„åŒºåˆ«åœ¨äº <code>send()</code> å’Œ <code>recv()</code> çš„å®ç°ï¼Œä¹Ÿå°±æ˜¯å®é™…çš„æ•°æ®ä¼ è¾“æ“ä½œã€‚</p>
<p>åœ¨ <code>recv()</code> å‡½æ•°ä¸­ï¼Œç¨‹åºåªçŸ¥é“æœ‰æ•°æ®éœ€è¦æ¥æ”¶ï¼Œä½†ä¸ç¡®å®šæ•°æ®æºæ˜¯ä» <code>sudog</code> å¯¹è±¡ä¸­è¿˜æ˜¯ä»ç¼“å†²é˜Ÿåˆ—ä¸­è·å–ï¼Œæ‰€ä»¥åœ¨æ¥æ”¶æ•°æ®å‰è¿˜éœ€è¦æ ¹æ® channel çš„çŠ¶æ€è¿›è¡Œåˆ¤æ–­ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.13</span>:<span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#66d9ef">chan</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">554</span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">recv</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span>, <span style="color:#a6e22e">sg</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sudog</span>, <span style="color:#a6e22e">ep</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>, <span style="color:#a6e22e">unlockf</span> <span style="color:#66d9ef">func</span>(), <span style="color:#a6e22e">skip</span> <span style="color:#66d9ef">int</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {	<span style="color:#75715e">//æ— ç¼“å†² channel å¤„ç†å…¥å£
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">raceenabled</span> {
			<span style="color:#a6e22e">racesync</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">sg</span>)
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ep</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#75715e">// copy data from sender
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">recvDirect</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemtype</span>, <span style="color:#a6e22e">sg</span>, <span style="color:#a6e22e">ep</span>)	<span style="color:#75715e">//ç›´æ¥ä»å‘é€çš„ goroutine ä¸­æ‹·è´æ•°æ®
</span><span style="color:#75715e"></span>		}
	} <span style="color:#66d9ef">else</span> {	<span style="color:#75715e">// çœ‹æ³¨é‡Šâ†“â†“â†“â†“â†“â†“
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// Queue is full. Take the item at the
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// head of the queue. Make the sender enqueue
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// its item at the tail of the queue. Since the
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// queue is full, those are both the same slot.
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">qp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">chanbuf</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvx</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">raceenabled</span> {	<span style="color:#75715e">// ä¸ç”¨ç®¡ç³»åˆ—
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">raceacquire</span>(<span style="color:#a6e22e">qp</span>)
			<span style="color:#a6e22e">racerelease</span>(<span style="color:#a6e22e">qp</span>)
			<span style="color:#a6e22e">raceacquireg</span>(<span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">g</span>, <span style="color:#a6e22e">qp</span>)
			<span style="color:#a6e22e">racereleaseg</span>(<span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">g</span>, <span style="color:#a6e22e">qp</span>)
		}
		<span style="color:#75715e">// copy data from queue to receiver
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ep</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">typedmemmove</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemtype</span>, <span style="color:#a6e22e">ep</span>, <span style="color:#a6e22e">qp</span>)	<span style="color:#75715e">//å°†ç¼“å†²é˜Ÿåˆ—é˜Ÿé¦–çš„æ•°æ®æ‹·è´åˆ°å½“å‰æ¥æ”¶æ•°æ®çš„ goroutine ä¸­
</span><span style="color:#75715e"></span>		}
		<span style="color:#75715e">// copy data from sender to queue
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">typedmemmove</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">elemtype</span>, <span style="color:#a6e22e">qp</span>, <span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">elem</span>)	<span style="color:#75715e">//å°†é˜»å¡çš„å‘é€ goroutine ä¸­çš„æ•°æ®æ‹·è´åˆ°ç¼“å†²é˜Ÿåˆ—ä¸­
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvx</span><span style="color:#f92672">++</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvx</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dataqsiz</span> {
			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvx</span> = <span style="color:#ae81ff">0</span>
		}
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendx</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recvx</span> <span style="color:#75715e">// c.sendx = (c.sendx+1) % c.dataqsiz
</span><span style="color:#75715e"></span>	}
	<span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">elem</span> = <span style="color:#66d9ef">nil</span>
	<span style="color:#a6e22e">gp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">g</span>
	<span style="color:#a6e22e">unlockf</span>()
	<span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">param</span> = <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">sg</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">releasetime</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">sg</span>.<span style="color:#a6e22e">releasetime</span> = <span style="color:#a6e22e">cputicks</span>()
	}
	<span style="color:#a6e22e">goready</span>(<span style="color:#a6e22e">gp</span>, <span style="color:#a6e22e">skip</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)
}
</code></pre></div><p>åœ¨è¿™é‡Œï¼Œä¼ å…¥çš„ sg æ˜¯å‘é€æ•°æ®æ–¹çš„ä¸€ä¸ªå·²ç»è¿›å…¥ä¼‘çœ çš„ <code>sudog</code> ç»“æ„ä½“ã€‚ é¦–å…ˆæ£€æŸ¥ç¼“å†²é˜Ÿåˆ—å¤§å°ï¼Œå¦‚æœå¤§å°ä¸º0ï¼ˆæ— ç¼“å†² channel ï¼‰ï¼Œè°ƒç”¨ <code>recvDirect()</code> å¯¹æ•°æ®è¿›è¡Œ<!-- raw HTML omitted --><strong>ç›´æ¥æ‹·è´</strong><!-- raw HTML omitted -->ã€‚</p>
<p>å¦‚æœæ˜¯æœ‰ç¼“å†²é˜Ÿåˆ—çš„ channelï¼Œé‚£ä¹ˆè¡¨ç¤ºç¼“å†²é˜Ÿåˆ—å·²ç»æ»¡å‘˜ï¼ˆå› ä¸ºå‘é€é˜Ÿåˆ—å·²ç»æœ‰ goroutine é˜»å¡ï¼‰ï¼Œæ¥ä¸‹æ¥éœ€è¦å®Œæˆä¸¤ä»¶äº‹ï¼š</p>
<ol>
<li>å°†ç¼“å†²é˜Ÿåˆ—é˜Ÿé¦–çš„æ•°æ®æ‹·è´åˆ°å½“å‰æ¥æ”¶æ•°æ®çš„ goroutine ä¸­ã€‚</li>
<li>å°†é˜»å¡çš„å‘é€ goroutine ä¸­çš„æ•°æ®æ‹·è´åˆ°ç¼“å†²é˜Ÿåˆ—é˜Ÿå°¾ä¸­ã€‚</li>
</ol>
<p>å®Œæˆäº†æ•°æ®äº¤æ¥åï¼Œè°ƒç”¨ <code>goready()</code> è½»è½»å”¤é†’é˜»å¡çš„æ•°æ®å‘é€ goroutineï¼Œæ·±è—åŠŸä¸åã€‚</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<ul>
<li>è®¸å¤šæ–‡ç« å°† channel ç±»æ¯”ä¸ºâ€œç®¡é“â€ä¹‹ç±»çš„å·¥å…·ï¼Œä½†åœ¨äº†è§£ channel çš„å®Œæ•´è°ƒåº¦é€»è¾‘åï¼Œæˆ‘æ›´å¸Œæœ›å°†å…¶æ¯”ä½œä¸€ä¸ªé«˜é€Ÿå…¬è·¯ä¸­çš„è´§ç‰©ä¸­è½¬ç«™ã€‚æ¥æ¥å¾€å¾€çš„è´§è½¦å¸æœºï¼ˆgoroutineï¼‰åœ¨æ­¤è£…è´§å¸è´§ï¼Œæœ‰æ— ä»“åº“ï¼ˆç¼“å†²ï¼‰å†³å®šäº†è´§è½¦å¸æœºéœ€ä¸éœ€è¦åœ¨ä¸­è½¬ç«™é€—ç•™ç­‰å¾…ï¼Œè¿Ÿåˆ°çš„è´§è½¦å¸æœºè´Ÿè´£è´§ç‰©çš„è£…è½½æˆ–æ‹†å¸ï¼ˆæ•°æ®ä¼ è¾“ï¼‰å¹¶é€šçŸ¥å¯¹åº”çš„å¸æœºå®Œæˆè´§ç‰©äº¤æ¥ã€‚</li>
<li>Go åŸºäº CSP æ¨¡å‹ä¸­çš„ process å’Œ channel çš„æ¦‚å¿µè®¾è®¡äº†åŸºäº channel çš„å¹¶å‘æ¨¡å‹å¹¶æå€¡â€œé€šè¿‡é€šä¿¡å…±äº«å†…å­˜ï¼Œè€Œä¸æ˜¯é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡â€ã€‚ç„¶è€Œè¿™æ›´å¤šæ˜¯ä¸€ç§è¡Œä¸ºä¸Šçš„æ¦‚å¿µï¼Œå®é™…å®ç°ä¸­è¿˜æ˜¯æ— æ³•é¿å…åœ°å…±äº«äº† hchan ç”šè‡³ç¼“å†² buf ç­‰æ•°æ®ç»“æ„ã€‚å”¯ä¸€ä¸åŒçš„æ˜¯å½“ä¸¤ä¸ª goroutine ç›´æ¥äº¤æ¢æ•°æ®æ—¶ï¼Œä»–ä»¬æ˜¯å¯ä»¥ç›´æ¥æ“ä½œå¯¹æ–¹çš„å†…å­˜ç©ºé—´ï¼ˆé€šè¿‡ <code>sendDirect()</code> å’Œ <code>recvDirect()</code> ä¸¤ä¸ªæ–¹æ³•ï¼‰ï¼Œé¿å…äº†æ•°æ®çš„å¤šæ¬¡æ‹·è´å’Œé¢å¤–çš„é”æ“ä½œã€‚</li>
<li>ä¸ºäº†éµå¾ª FIFO åŸåˆ™ï¼ŒGo è¯­è¨€ç”¨ä¸¤ä¸ªæŒ‡é’ˆåŠ æ•°ç»„å®ç°äº†å¾ªç¯é˜Ÿåˆ—ï¼Œå®é™…ä¸Šè¿™å¤§æ¦‚ä¹Ÿæ˜¯é˜Ÿåˆ—çš„æœ€ä½³å®ç°æ–¹å¼äº† &hellip; &hellip; å§ï¼Ÿ</li>
<li>channel ä½¿ç”¨ mutex æ¥ä¿éšœå®ƒæ˜¯ goroutine å®‰å…¨çš„ï¼Œä½†æ˜¯ä½œä¸ºä¸€ä¸ªå¯¹æ€§èƒ½è¦æ±‚æé«˜çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°è§£é”æ“ä½œå¹¶ä¸ä¸€å®šæ˜¯åœ¨å½“å‰åŠ é”çš„å¤„ç†å‡½æ•°ä¸­ã€‚å®ƒé€šè¿‡ä¼ é€’è§£é”æ¥å£ <code>unlockf()</code> æ¥ç¡®ä¿å¯¹æ•°æ®ä¿®æ”¹ç»“æŸåç¬¬ä¸€æ—¶é—´è¿›è¡Œé”çš„é‡Šæ”¾ï¼Œä»è€Œå®ç°é”çš„è¦†ç›–æ—¶é—´æ˜¯æœ€çŸ­çš„ã€‚</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<p><a href="https://speakerdeck.com/kavya719/understanding-channels">diving-deep-into-the-golang-channels</a></p>

    </div>

    

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s): 
            
            <span class="tag"><a href="https://huangyubin.xyz/tags/golang/">
                    #Golang</a></span>
            
            <span class="tag"><a href="https://huangyubin.xyz/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">
                    #æºç å­¦ä¹ </a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> Â· 
                <span><a href="https://huangyubin.xyz">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://huangyubin.xyz/2019/05/mysql-%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/" class="prev" rel="prev" title="MySQL å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶"><i class="iconfont icon-left"></i>&nbsp;MySQL å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶</a>
         
        
        <a href="https://huangyubin.xyz/2019/09/mysql-%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6%E7%9A%84%E6%80%9D%E8%80%83/" class="next" rel="next" title="MySQL åŒæ­¥å¤åˆ¶çš„æ€è€ƒ">MySQL åŒæ­¥å¤åˆ¶çš„æ€è€ƒ&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
          
                 
                     <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "bingo-1994" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                 
                 
          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2018 - 2021</span>
        
         
            <span class="author" itemprop="copyrightHolder"><a href="https://huangyubin.xyz">BinGo</a> | </span> 
         

         
		<span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 

    </div>
</footer>












    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  



     </div>
  </body>
</html>
